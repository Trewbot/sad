<!DOCTYPE html>
<!--
  -     sad.moe
  -     Written by Trevor Hoglund (@trewbot)
  -     2017.11.28
  -->
<html>
	<head>
		<title>):</title>
		<meta charset="utf-8">
		<meta name="viewport" content="user-scalable=no, initial-scale=1, width=device-width">
        <link href="https://fonts.googleapis.com/css?family=Playfair+Display:900i" rel="stylesheet">
		<link rel="shortcut icon" type="image/jpg" href="assets/fav.jpg"/>
        <style>
			html,body{margin:0;padding:0;overflow:hidden;}
            div.caption{
                color:#fff0f0;
                font-family:'Playfair Display',serif;
                font-size:8rem;
                left:0;
                position:fixed;
                text-align:center;
                top:calc(50vh - 6rem);
                width:100%;
                z-index:100;
            }
            @media print, screen and (max-width:1000px){
                div.caption{
                    display:none;
                }
            }
		</style>
		<script src="lib/dep.js"></script>
		<script src="lib/three.min.js"></script>
		<script src="lib/DeviceOrientationControls.js"></script>
		<!-- Controls Setup -->
		<script>
			//	Create CONTROL Object
			var CONTROL			= {
				gamepadAdd		(gamepad){
					var indx = gamepad.index;
					if(!CONTROL.gamepads[indx]){
						CONTROL.gamepads[indx] = gamepad;
		                CONTROL.gamepadCount++;
						CONTROL.gamepads[indx].buttonValue = (key)=>{
							return function(){
								return CONTROL.gamepads[indx].buttons[key]
							}
						}
						CONTROL.gamepads[indx].axesValue = (key,invert,dz)=>{
							return function(){
								var val = CONTROL.gamepads[indx].axes[key];
								return Math.abs(val)<dz?0:(invert?-1:1)*val;
							}
						}
						CONTROL.binding.forward.push(
							CONTROL.gamepads[0].axesValue(1,!0,0.3)
						);
						CONTROL.binding.right.push(
							CONTROL.gamepads[0].axesValue(0,!1,0.3)
						);
						CONTROL.binding.lookUp.push(
							CONTROL.gamepads[0].axesValue(3,!1,0.3)
						);
						CONTROL.binding.lookRight.push(
							CONTROL.gamepads[0].axesValue(2,!1,0.3)
						);
					}else{
						for(let i in gamepad.buttons)
							CONTROL.gamepads[indx].buttons[i] = gamepad.buttons[i];
						for(let i in gamepad.axes)
							CONTROL.gamepads[indx].axes[i] = gamepad.axes[i];
					}
				},
				gamepadCount	: 0,
				gamepadHandler	(e,connecting){
	                var gamepad = e.gamepad;
	                if(connecting){
	                    addgamepad(gamepad);
	                }else{
	                    delete gamepads[gamepad.index];
	                    CONTROL.gamepadCount--;
	                }
				},
				gamepadPoll		(){
					for(let i of navigator.getGamepads())
	                    if(i) CONTROL.gamepadAdd(i);
				},
				gamepads		: {},
				keys			: {37:0,38:0,39:0,40:0,65:0,68:0,83:0,87:0},
				keyValue		(key,invert){
					return function(){return (invert?-1:1)*CONTROL.keys[key]}
				}
			};
			CONTROL.binding = {
				forward		: [CONTROL.keyValue(87,!1),CONTROL.keyValue(38,!1),
							   CONTROL.keyValue(83,!0),CONTROL.keyValue(40,!0)],
				right		: [CONTROL.keyValue(68,!1),CONTROL.keyValue(39,!1),
							   CONTROL.keyValue(65,!0),CONTROL.keyValue(37,!0)],
				lookUp		: [],
				lookRight	: []
			};

			//  Gamepad Setup
            window.addEventListener("gamepadconnected",
				(e)=>CONTROL.gamepadHandler(e,!0),!1);
            window.addEventListener("gamepaddisconnected",
				(e)=>CONTROL.gamepadHandler(e,!1),!1);

			//	Key Listener
			document.addEventListener('keydown',(e)=>{
                CONTROL.keys[e.keyCode] = 1.},!1);
            document.addEventListener('keyup',(e)=>{
                CONTROL.keys[e.keyCode] = 0.},!1);

			//	Pointerlock Setup
			CONTROL.PointerLock = function(element,lock,unlock){
	            element.requestPointerLock  =  element.requestPointerLock
	                                        || element.mozRequestPointerLock
	                                        || element.webkitRequestPointerLock;
	            document.addEventListener('mousedown',()=>{
	                element.requestPointerLock()
	            },!1);
	            document.exitPointerLock    =  document.exitPointerLock
	                                        || document.mozExitPointerLock
	                                        || document.webkitExitPointerLock;
	            const
	                pl          =  'pointerLockElement' in document
	                            || 'mozPointerLockElement' in document
	                            || 'webkitPointerLockElement' in document,
	                plcb        = (e)=>{
	                    if(document.pointerLockElement===element
	                    || document.mozPointerLockElement===element
	                    || document.webkitPointerLockElement===element){
							lock();
	                    } else {
							unlock();
	                    }
	                },
	                ercb        = (e)=>{
	                    alert("Oh no.");
	                    console.error(e);
	                };
	            document.addEventListener('pointerlockchange',plcb,!1);
	            document.addEventListener('mozpointerlockchange',plcb,!1);
	            document.addEventListener('webkitpointerlockchange',plcb,!1);
	            document.addEventListener('pointerlockerror',ercb,!1);
	            document.addEventListener('mozpointerlockerror',ercb,!1);
	            document.addEventListener('webkitpointerlockerror',ercb,!1);
			}
		</script>
		<!-- Camera Controls -->
		<script>
			CONTROL.Camera = function(camera){
				//	Camera Setup
				var scope		= this,
					pitchObject	= new THREE.Object3D(),
					yawObject	= new THREE.Object3D(),
					PI_2		= Math.PI / 2;
				camera.rotation.set(0,0,0);
				pitchObject.add(camera);
				yawObject.position.y = 10;
				yawObject.add(pitchObject);

				//	Settings
				this.enableMouse		= false; //	Toggle Mouse Controls
				this.mouseSensitivity	= 0.002; //	Mouse movement sensitivity
				this.controlSensitivity	= 0.05; //	Gamepad movement sensitivy

				//	Mouse Movement
				var onMouseMove = function(e){
					if(!scope.enableMouse) return;
					var dX	=  e.movementX
							|| e.mozMovementX
							|| e.webkitMovementX
							|| 0,
						dY	=  e.movementY
							|| e.mozMovementY
							|| e.webkitMovementY
							|| 0;
					yawObject.rotation.y	-= dX * scope.mouseSensitivity;
					pitchObject.rotation.x	-= dY * scope.mouseSensitivity;
					pitchObject.rotation.x	= Math.constrain(
						pitchObject.rotation.x,
						-PI_2,PI_2
					);
				};
				document.addEventListener('mousemove',onMouseMove,!1);
				this.dispose = function(){
					document.removeEventListener('mousemove',onMouseMove,!1);
				};

				//	Control Movement
				this.update = function(){
					var dX	= (Math.constrain(
							Math.sum(...CONTROL.binding.lookRight)
						,-1,1)),
						dY	= (Math.constrain(
							Math.sum(...CONTROL.binding.lookUp)
						,-1,1));
					yawObject.rotation.y	-= dX * scope.controlSensitivity;
					pitchObject.rotation.x	-= dY * scope.controlSensitivity;
					pitchObject.rotation.x	= Math.constrain(
						pitchObject.rotation.x,
						-PI_2,PI_2
					);
				}

				//	Returns
				this.getObject = function(){return yawObject;};
				this.getDirection = (()=>{
					var direction	= new THREE.Vector3(0,0,-1);
						rotation	= new THREE.Euler(0,0,0,"YXZ");
					return function(v) {
						rotation.set(pitchObject.rotation.x,yawObject.rotation.y,0);
						v.copy(direction).applyEuler(rotation);
						return v;
					};
				})();
			};
		</script>
		<!-- Movement Controls -->
		<script>
			CONTROL.Move = {
				speed : 0.042,
				update(){
					//  Position controls
					var fwd         = (new THREE.Vector3(0,0,-1)).applyQuaternion(head().quaternion),
						pos         = head().position.clone(),
						str         = fwd.clone().cross(camera.up),
						speed       = this.speed,
						fwdscale    = (Math.constrain(
							Math.sum(...CONTROL.binding.forward)
						,-1,1))*speed,
						strscale    = (Math.constrain(
							Math.sum(...CONTROL.binding.right)
						,-1,1))*speed;
					fwd.multiplyScalar(fwdscale);
					str.multiplyScalar(strscale);
					pos.add(fwd);
					pos.add(str);
					head().position.set(pos.x,1.52,pos.z);
				}
			}
		</script>
	</head>
    <body>
        <div class="caption">click here.</div>
        <script>
            //	Scene Setup
            const
                scene		= new THREE.Scene(),
                aspect		= window.innerWidth/window.innerHeight,
                camera		= new THREE.PerspectiveCamera(75,aspect,0.1,1e3),
				m			= window.mobilecheck(),
                camcon      = m
                    ? new THREE.DeviceOrientationControls(camera)
                    : new CONTROL.Camera(camera),
				head		= ()=>{return m?camera:camcon.getObject()},
				renderer	= new THREE.WebGLRenderer(),
                r			= ()=>Math.random();
            scene.background	= new THREE.Color(0xffcccc);
            scene.fog           = new THREE.FogExp2(0xffcccc,0.16);
            scene.add(head());
            head().position.x	= m?0:2;
            head().position.y	= 1.52;
            head().position.z	= 4;
            renderer.setSize(window.innerWidth,window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

			var paused = !m;

            //  Pointerlock Setup
			var lockscreen = document.getElementsByClassName('caption')[0];
            CONTROL.PointerLock(
				renderer.domElement,
				()=>{
					paused=!1;
					camcon.enableMouse=!0;
					lockscreen.style.display='none';
				},
				()=>{
					paused=!0;
					camcon.enableMouse=!1;
					if(!m)lockscreen.style.display='';
				}
			);

            //  Add Ground
            var gnd_geo = new THREE.PlaneGeometry(600,600),
                gnd_mat = new THREE.MeshStandardMaterial({
                    color:0xffc8c8,
                    roughness:1,
                    metalness:0,
                    emissive:0
                }),
                plane     = new THREE.Mesh(gnd_geo,gnd_mat);
            plane.position.y = 0;
            plane.rotation.x = -Math.PI/2;
            plane.doubleSided = true;
            plane.receiveShadow = true;
            scene.add(plane);

            //  Add Cube
            var geometry = new THREE.BoxGeometry(1, 1, 1),
                material = new THREE.MeshLambertMaterial({color:0xffc0c0}),
                cube = new THREE.Mesh(geometry, material);
            cube.position.y = 0.5;
            cube.castShadow = true;
			if(m) cube.rotation.y = -Math.PI/6;
            scene.add(cube);

            //  Add Lighting
            var light = new THREE.PointLight(0xffffff,0.15);
            light.position.set(-2.2,5,1.8);
            light.castShadow = true;
            scene.add(light);
            var light2 = new THREE.AmbientLight(0xffffff,0.95);
            scene.add(light2);

			//	Snow Generation
			const particles	= [];
			var	spriteMap 	= new THREE.TextureLoader().load('assets/snow.png'),
				material	= new THREE.SpriteMaterial({map:spriteMap,fog:!0});
			for(let i=0;i<2e3;i++){
				let p = new THREE.Sprite(material);
				p.velocity = new THREE.Vector3(0,-0.1,0);
				p.position.x = (r()*64)-32,
				p.position.y = (r()*64),
				p.position.z = (r()*64)-32,
				scene.add(p);
				particles.push(p);
			}

			//	Rendering Loop
			(render	= ()=>{
				//	Loop
				requestAnimationFrame(render);
				//	Handle Snow
				for(var i of particles){
					i.position.add(i.velocity);
					i.position.y += i.position.y<-2?64:0;
				}
                //	Scene Control
				if(!paused){
	                CONTROL.gamepadPoll();
	                CONTROL.Move.update();
					camcon.update();
				}
				renderer.render(scene,camera);
			})();

			//	Handle Resize
			if(!window.mobilecheck())window.addEventListener('resize',()=>{
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			},!1);
        </script>
    </body>
</html>

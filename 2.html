<!DOCTYPE html>
<!--
  -     sad.moe
  -     Written by Trevor Hoglund (@trewbot)
  -     2017.11.27
  -->
<html>
	<head>
		<title>):</title>
		<meta charset="utf-8">
		<meta name="viewport" content="user-scalable=no, initial-scale=1, width=device-width">
        <link href="https://fonts.googleapis.com/css?family=Playfair+Display:900i" rel="stylesheet">
        <style>
			html,body{margin:0;padding:0;overflow:hidden;}
            div.caption{
                color:#fff0f0;
                font-family:'Playfair Display',serif;
                font-size:8rem;
                left:0;
                position:fixed;
                text-align:center;
                top:calc(50vh - 6rem);
                width:100%;
                z-index:100;
            }
		</style>
		<script src="lib/dep.js"></script>
		<script src="lib/three.min.js"></script>
		<script src="lib/PointerLockControls.js"></script>
	</head>
    <body>
        <div class="caption">click here.</div>
        <script>
            //	Scene Setup
            const
                scene		= new THREE.Scene(),
                aspect		= window.innerWidth/window.innerHeight,
                camera		= new THREE.PerspectiveCamera(75,aspect,0.1,1e3),
                camcon      = new THREE.PointerLockControls(camera),
				renderer	= new THREE.WebGLRenderer(),
                r			= ()=>Math.random();
            scene.background	= new THREE.Color(0xffcccc);
            scene.fog           = new THREE.FogExp2(0xffcccc,0.16);
            scene.add(camcon.getObject());
            camcon.getObject().position.x	= 2;
            camcon.getObject().position.y	= 1.5;
            camcon.getObject().position.z	= 4;
            renderer.setSize(window.innerWidth,window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            //  Pointerlock Setup
            var element         = renderer.domElement;
            element.requestPointerLock  =  element.requestPointerLock
                                        || element.mozRequestPointerLock
                                        || element.webkitRequestPointerLock;
            document.addEventListener('mousedown',()=>{
                element.requestPointerLock()
            },!1);
            document.exitPointerLock    =  document.exitPointerLock
                                        || document.mozExitPointerLock
                                        || document.webkitExitPointerLock;
            const
                pl          =  'pointerLockElement' in document
                            || 'mozPointerLockElement' in document
                            || 'webkitPointerLockElement' in document,
                plcb        = (e)=>{
                    if(document.pointerLockElement===element
                    || document.mozPointerLockElement===element
                    || document.webkitPointerLockElement===element){
                        camcon.enabled = true;
                        document.getElementsByClassName('caption')[0].style.display = 'none';
                    } else {
                        camcon.enabled = false;
                        document.getElementsByClassName('caption')[0].style.display = '';
                        //unlockHook(this.element);
                    }
                },
                ercb        = (e)=>{
                    alert("Oh no.");
                    console.error(e);
                };
            document.addEventListener('pointerlockchange',plcb,!1);
            document.addEventListener('mozpointerlockchange',plcb,!1);
            document.addEventListener('webkitpointerlockchange',plcb,!1);
            document.addEventListener('pointerlockerror',ercb,!1);
            document.addEventListener('mozpointerlockerror',ercb,!1);
            document.addEventListener('webkitpointerlockerror',ercb,!1);
            //document.addEventListener('mousemove',movecb,!1);

            //  Gamepad Setup
            var gamepads = {}, gps = 0;
            function addgamepad(gamepad){
                gamepads[gamepad.index] = gamepad;
                gps++;
            }
            function gamepadHandler(event,connecting){
                var gamepad = event.gamepad;
                if(connecting){
                    addgamepad(gamepad);
                }else{
                    delete gamepads[gamepad.index];
                    gps--;
                }
            }
            function pollgp(){
                for(let i of navigator.getGamepads())
                    if(i) addgamepad(i);
            }
            window.addEventListener("gamepadconnected",(e)=>gamepadHandler(e,!0),!1);
            window.addEventListener("gamepaddisconnected",(e)=>gamepadHandler(e,!1),!1);

            //  Movement Control Setup
            var controls = {
                cameraSpeed : 0.1,
                keys : {W:0,A:0,S:0,D:0},
                update(){
                    //  Position controls
                    var fwd         = (new THREE.Vector3(0,0,-1)).applyQuaternion(camcon.getObject().quaternion),
                        pos         = camcon.getObject().position.clone(),
                        str         = fwd.clone().cross(camera.up),
                        speed       = this.cameraSpeed,
                        fwdscale    = (
                            gps>0
                            ? Math.abs(gamepads[0].axes[1]) < 1/3
                                ? 0
                                : -gamepads[0].axes[1]
                            : this.keys.W-this.keys.S
                        )*speed,
                        strscale    = (
                            gps>0
                            ? Math.abs(gamepads[0].axes[0]) < 1/3
                                ? 0
                                : gamepads[0].axes[0]
                            : this.keys.D-this.keys.A
                        )*speed;
                    fwd.multiplyScalar(fwdscale);
                    str.multiplyScalar(strscale);
                    pos.add(fwd);
                    pos.add(str);
                    camcon.getObject().position.set(pos.x,1.5,pos.z);
                }
            }
            document.addEventListener('keydown',(e)=>{
                switch(e.key){
                    case 'w': controls.keys.W = 1; break;
                    case 'a': controls.keys.A = 1; break;
                    case 's': controls.keys.S = 1; break;
                    case 'd': controls.keys.D = 1; break;
                }
            },!1);
            document.addEventListener('keyup',(e)=>{
                switch(e.key){
                    case 'w': controls.keys.W = 0; break;
                    case 'a': controls.keys.A = 0; break;
                    case 's': controls.keys.S = 0; break;
                    case 'd': controls.keys.D = 0; break;
                }
            },!1);

            //  Add Ground
            var gnd_geo = new THREE.PlaneGeometry(600,600),
                gnd_mat = new THREE.MeshStandardMaterial({
                    color:0xffc8c8,
                    roughness:1,
                    metalness:0,
                    emissive:0
                }),
                plane     = new THREE.Mesh(gnd_geo,gnd_mat);
            plane.position.y = 0;
            plane.rotation.x = -Math.PI/2;
            plane.doubleSided = true;
            plane.receiveShadow = true;
            scene.add(plane);

            //  Add Cube
            var geometry = new THREE.BoxGeometry(1, 1, 1),
                material = new THREE.MeshLambertMaterial({color:0xffc0c0}),
                cube = new THREE.Mesh(geometry, material);
            cube.position.y = 0.5;
            cube.castShadow = true;
            scene.add(cube);

            //  Add Lighting
            var light = new THREE.PointLight(0xffffff,0.15);
            light.position.set(
                (-2.5)+(Math.random()*5),
                5,
                (Math.random()*2.5)
            );
            light.castShadow = true;
            scene.add(light);
            var light2 = new THREE.AmbientLight(0xffffff,0.95);
            scene.add(light2);

			//	Rendering Loop
			(render	= ()=>{
				//	Loop
				requestAnimationFrame(render);
                //	Scene Control
                pollgp();
                controls.update();
                renderer.render(scene,camera);
			})();

			//	Handle Resize
			if(!window.mobilecheck())window.addEventListener('resize',()=>{
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			},!1);
        </script>
    </body>
</html>
